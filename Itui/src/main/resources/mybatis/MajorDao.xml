<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="cn.itui.webdevelop.dao.MajorDao">
	<select id="findMajorById" parameterType="int" resultType="cn.itui.webdevelop.model.Major">
		SELECT
			id as id,
			name as name,
			code as code,
			school as school,
			college_id as collegeId,
			subject_id as subjectId,
			type as type
		FROM major 
		WHERE id=#{majorId}
	</select>
	
	<select id="findCodeLikeMajorByCollegeId" parameterType="map" resultType="java.util.HashMap">
		SELECT 
			major.id as id,
			major.name as name, 
			major.school as school, 
			major.code as code, 
			major_info.rate as rate
		FROM major, major_info
		WHERE major.code LIKE #{code} AND major.id=major_info.major_id AND major.college_id=#{collegeId}
	</select>
	
	<select id="findMajorByCollegeIdAndNotInMajorIds" parameterType="map" resultType="java.util.HashMap">
		SELECT
			major.id as id,
			major.name as name, 
			major.school as school, 
			major.code as code, 
			major_info.rate as rate
		FROM major, major_info
		WHERE major.id=major_info.major_id AND major.college_id=#{collegeId}
	</select>
	
	<select id="findAreaSameCodeMajorByCollegeIdAndMajorCode" parameterType="map" resultType="java.util.HashMap">
		SELECT major.name as name, major.school as school, college.name as college, major_info.rate as applyAdmitRate
		FROM major,major_info,college
		WHERE major.id = major_info.major_id
		      AND major.college_id = college.id
		      AND college.city_id in (
				select id as cityId
				from city
				where area_id in (
					select city.area_id
					from city, college
					where college.city_id = city.id and college.id=#{collegeId}
				)
		     AND major.code = #{majorCode}
		     AND college.id NOT In (#{collegeId})
		)
		ORDER BY applyAdmitRate
	</select>
	<select id="findAllMajors" resultType="java.util.HashMap">
		SELECT 
			major.id as id,
			major.name as name,
			major.school as school,
			college.name as college,
			college.logo as logo,
			college.is_985 as is985,
			college.is_211 as is211,
			college.is_34 as is34
		FROM
			major left join college on major.college_id = college.id			
	</select>
	<select id = "searchMajors" parameterType="map" resultType="java.util.HashMap">
		SELECT
			SQL_CALC_FOUND_ROWS 
			major.id as id,
			major.name as name,
			school,
			s.name as college,
			s.logo as logo,
			s.is_985 as is985,
			s.is_34 as is34,
			s.is_211 as is211,
			major_rank as rank,
			degree as degree
		FROM
			(major join 
				(select 
					id,name,logo,is_985, is_34, is_211 
				from 
					college 
				where 
					city_id in
						(select 
							id 
						from 
							city 
						where 
							area_id in 
								(select 
									id 
								from 
									area 
								where 
									name like #{area})) 
					and is_985 like #{is985} 
					and is_34 like #{is34} 
					and is_211 like #{is211}) 
			as s on s.id = college_id) join major_info on major_info.major_id = major.id
		WHERE 
			subject_id in 
				(select 
					id 
				from 
					subject 
				where
					name like #{subject} and category_id in 
						(select 
							id 
						from 
							category 
						where 
							name like #{category})) 
			and type like #{type}
			and major.name like #{condition}
		LIMIT #{from},#{limit}
	</select>
	<select id="count" resultType="java.lang.Integer">
		SELECT FOUND_ROWS()
	</select>
</mapper>